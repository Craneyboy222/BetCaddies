// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Run {
  id            String   @id @default(cuid())
  runKey        String   @unique
  weekStart     DateTime
  weekEnd       DateTime
  status        String   // 'pending', 'running', 'completed', 'failed'
  createdAt     DateTime @default(now())
  completedAt   DateTime?

  // Relations
  tourEvents         TourEvent[]
  fieldEntries       FieldEntry[]
  weatherForecasts   WeatherForecast[]
  leaderboardSnapshots LeaderboardSnapshot[]
  oddsEvents         OddsEvent[]
  betRecommendations BetRecommendation[]
  dataIssues         DataIssue[]
  runArtifacts       RunArtifact[]

  @@map("runs")
}

model RunArtifact {
  id           String   @id @default(cuid())
  runId        String
  tour         String?
  endpoint     String
  paramsJson   Json
  payloadJson  Json?
  payloadHash  String?
  payloadBytes Int?
  artifactRef  String?
  fetchedAt    DateTime @default(now())

  run          Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@map("run_artifacts")
}

model HistoricalRound {
  id               String   @id @default(cuid())
  tour             String
  eventId          String
  year             Int
  playerId         String
  round            Int
  statsJson        Json
  strokesGainedJson Json?
  teeTimeUtc       DateTime?
  createdAt        DateTime @default(now())

  @@index([tour, eventId, year])
  @@index([playerId])
  @@map("historical_rounds")
}

model TourEvent {
  id          String   @id @default(cuid())
  runId       String
  tour        String   // 'PGA', 'LPGA', 'LIV'
  eventName   String
  startDate   DateTime
  endDate     DateTime
  location    String
  courseName  String
  courseLat   Float?
  courseLng   Float?
  sourceUrls  Json     // JSON array of source URLs
  createdAt   DateTime @default(now())

  // Relations
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)
  fieldEntries FieldEntry[]
  teeTimes    TeeTime[]
  weatherForecasts WeatherForecast[]
  leaderboardSnapshots LeaderboardSnapshot[]
  oddsEvents  OddsEvent[]
  predictions Prediction[]
  betRecommendations BetRecommendation[]

  @@unique([runId, tour])
  @@map("tour_events")
}

model Player {
  id            String   @id @default(cuid())
  dgId          String?  @unique
  canonicalName String   @unique
  aliases       Json     // JSON array of string aliases
  country       String?
  tourIds       Json     // JSON array of tour IDs
  createdAt     DateTime @default(now())

  // Relations
  fieldEntries FieldEntry[]
  teeTimes     TeeTime[]
  predictions  Prediction[]

  @@map("players")
}

model FieldEntry {
  id          String   @id @default(cuid())
  runId       String
  tourEventId String
  playerId    String
  status      String   // 'active', 'withdrawn', 'unknown'
  createdAt   DateTime @default(now())

  // Relations
  run         Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent   TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)
  player      Player    @relation(fields: [playerId], references: [id])

  @@unique([tourEventId, playerId])
  @@map("field_entries")
}

model TeeTime {
  id          String   @id @default(cuid())
  tourEventId String
  round       Int
  playerId    String?
  teeTimeUtc  DateTime
  tee         String
  groupMeta   Json     // JSON object with group information
  createdAt   DateTime @default(now())

  // Relations
  tourEvent   TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)
  player      Player?   @relation(fields: [playerId], references: [id])

  @@map("tee_times")
}

model Course {
  id          String   @id @default(cuid())
  name        String   @unique
  lat         Float?
  lng         Float?
  par         Int?
  yardage     Int?
  typeTags    Json     // JSON array of course type tags
  notes       String?
  sources     Json     // JSON object with source information
  createdAt   DateTime @default(now())

  @@map("courses")
}

model WeatherForecast {
  id            String   @id @default(cuid())
  runId         String
  tourEventId   String
  forecastJson  Json     // JSON object with weather data
  provider      String
  fetchedAt     DateTime @default(now())

  // Relations
  run           Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent     TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)

  @@map("weather_forecasts")
}

model LeaderboardSnapshot {
  id          String   @id @default(cuid())
  runId       String
  tourEventId String
  round       Int
  leaderboardJson Json  // JSON object with leaderboard data
  fetchedAt   DateTime @default(now())

  // Relations
  run         Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent   TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)

  @@map("leaderboard_snapshots")
}

model OddsEvent {
  id              String   @id @default(cuid())
  runId           String
  tourEventId     String
  oddsProvider    String   // 'the_odds_api'
  externalEventId String
  matchConfidence Float?  @map("match_confidence")
  matchMethod     String? @map("match_method")
  raw             Json     // Raw API response
  fetchedAt       DateTime @default(now())

  // Relations
  run             Run         @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent       TourEvent   @relation(fields: [tourEventId], references: [id], onDelete: Cascade)
  oddsMarkets     OddsMarket[]

  @@map("odds_events")
}

model OddsMarket {
  id          String   @id @default(cuid())
  oddsEventId String
  marketKey   String   // 'outright_winner', 'top_5', etc.
  raw         Json     // Raw market data
  fetchedAt   DateTime @default(now())

  // Relations
  oddsEvent   OddsEvent @relation(fields: [oddsEventId], references: [id], onDelete: Cascade)
  oddsOffers  OddsOffer[]

  @@map("odds_markets")
}

model OddsOffer {
  id            String   @id @default(cuid())
  oddsMarketId  String
  selectionId   String?
  selectionName String
  bookmaker     String
  oddsDecimal   Float
  oddsDisplay   String
  deepLink      String?
  fetchedAt     DateTime @default(now())

  // Relations
  oddsMarket    OddsMarket @relation(fields: [oddsMarketId], references: [id], onDelete: Cascade)

  @@unique([oddsMarketId, selectionName, bookmaker])
  @@map("odds_offers")
}

model Prediction {
  id            String   @id @default(cuid())
  tourEventId   String
  playerId      String
  probsJson     Json     // JSON object with probability data
  modelVersion  String
  createdAt     DateTime @default(now())

  // Relations
  tourEvent     TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)
  player        Player    @relation(fields: [playerId], references: [id])

  @@map("predictions")
}

model BetRecommendation {
  id                String   @id @default(cuid())
  runId             String
  tier              String   // 'PAR', 'BIRDIE', 'EAGLE', 'LONG_SHOTS'
  tourEventId       String
  marketKey         String
  selection         String   // Player name or outcome
  confidence1To5    Int
  bestBookmaker     String
  bestOdds          Float
  altOffersJson     Json     // JSON array of alternative offers (exactly 5)
  fairProb          Float?
  marketProb        Float?
  probSource        String?
  marketProbSource  String?
  edge              Float?
  ev                Float?
  isFallback        Boolean  @default(false)
  fallbackReason    String?
  fallbackType      String?
  tierStatus        String?
  mode              String?
  booksUsed         Json?
  analysisParagraph String
  analysisBullets   Json     // JSON array of bullet points
  createdAt         DateTime @default(now())

  // Admin overrides (optional)
  override          BetOverride?

  // Relations
  run               Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent         TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)

  @@map("bet_recommendations")
}

model BetOverride {
  id                   String   @id @default(cuid())
  betRecommendationId   String   @unique

  selectionName         String?
  betTitle              String?
  confidenceRating      Int?
  aiAnalysisParagraph   String?
  affiliateLinkOverride String?
  status                String?
  courseFitScore        Int?
  formLabel             String?
  weatherLabel          String?

  tierOverride          String?
  pinned                Boolean  @default(false)
  pinOrder              Int?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  betRecommendation     BetRecommendation @relation(fields: [betRecommendationId], references: [id], onDelete: Cascade)

  @@map("bet_overrides")
}

model DataIssue {
  id          String   @id @default(cuid())
  runId       String
  tour        String?
  severity    String   // 'info', 'warning', 'error'
  step        String
  message     String
  evidenceJson Json?   // JSON object with evidence data
  resolved    Boolean  @default(false)
  createdAt   DateTime @default(now())

  // Relations
  run         Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@map("data_issues")
}

model User {
  id                    String   @id @default(cuid())
  email                 String   @unique
  fullName              String?
  role                  String   @default("user")

  disabledAt            DateTime?
  disabledReason        String?

  favoriteTours         Json?
  riskAppetite          String?
  notificationsEnabled  Boolean  @default(true)
  emailNotifications    Boolean  @default(true)
  onboardingCompleted   Boolean  @default(false)
  totalBetsPlaced       Int      @default(0)
  totalWins             Int      @default(0)
  hioTotalPoints        Int      @default(0)
  createdAt             DateTime @default(now())

  @@map("users")
}

model SiteContent {
  key       String   @id
  json      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_contents")
}

model AuditLog {
  id              String   @id @default(cuid())
  action          String

  entityType      String?
  entityId        String?

  actorSub        String?
  actorEmail      String?
  actorRole       String?
  impersonatedSub String?

  beforeJson      Json?
  afterJson       Json?

  ip              String?
  userAgent       String?

  createdAt       DateTime @default(now())

  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

model BettingProvider {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  logoUrl          String?
  affiliateBaseUrl String?
  priority         Int      @default(10)
  enabled          Boolean  @default(true)
  createdAt        DateTime @default(now())

  @@map("betting_providers")
}

model MembershipPackage {
  id            String   @id @default(cuid())
  name          String
  description   String?
  price         Float
  billingPeriod String
  features      Json
  badges        Json
  stripePriceId String?
  stripeProductId String?
  displayOrder  Int      @default(0)
  enabled       Boolean  @default(true)
  createdAt     DateTime @default(now())

  subscriptions MembershipSubscription[]

  @@map("membership_packages")
}

model MembershipSubscription {
  id               String   @id @default(cuid())
  userEmail        String
  packageId        String
  packageName      String
  status           String
  billingPeriod    String
  pricePaid        Float
  stripeCustomerId String?
  stripeSubscriptionId String? @unique
  stripePriceId    String?
  lifetimeValue    Float?
  nextPaymentDate  DateTime?
  createdDate      DateTime @default(now())
  cancelledAt      DateTime?
  cancelAtPeriodEnd Boolean?

  package          MembershipPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@map("membership_subscriptions")
}

model HIOChallenge {
  id               String   @id @default(cuid())
  status           String   @default("active")
  prizeDescription String?
  tournamentNames  Json?
  questions        Json
  totalEntries     Int      @default(0)
  perfectScores    Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  entries          HIOEntry[]

  @@index([status])
  @@map("hio_challenges")
}

model HIOEntry {
  id          String   @id @default(cuid())
  challengeId String
  userEmail   String
  answers     Json
  submittedAt DateTime @default(now())
  score       Int?
  isPerfect   Boolean?

  challenge   HIOChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userEmail])
  @@index([userEmail])
  @@map("hio_entries")
}