generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Run {
  id                   String                @id @default(cuid())
  runKey               String                @unique
  weekStart            DateTime
  weekEnd              DateTime
  status               String
  createdAt            DateTime              @default(now())
  completedAt          DateTime?
  betRecommendations   BetRecommendation[]
  dataIssues           DataIssue[]
  fieldEntries         FieldEntry[]
  leaderboardSnapshots LeaderboardSnapshot[]
  oddsEvents           OddsEvent[]
  runArtifacts         RunArtifact[]
  tourEvents           TourEvent[]
  weatherForecasts     WeatherForecast[]

  @@map("runs")
}

model RunArtifact {
  id           String   @id @default(cuid())
  runId        String
  tour         String?
  endpoint     String
  paramsJson   Json
  payloadJson  Json?
  payloadHash  String?
  payloadBytes Int?
  artifactRef  String?
  fetchedAt    DateTime @default(now())
  run          Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@index([runId])
  @@map("run_artifacts")
}

model HistoricalRound {
  id                String    @id @default(cuid())
  tour              String
  eventId           String
  year              Int
  playerId          String
  round             Int
  statsJson         Json
  strokesGainedJson Json?
  teeTimeUtc        DateTime?
  createdAt         DateTime  @default(now())

  @@index([tour, eventId, year])
  @@index([playerId])
  @@map("historical_rounds")
}

model TourEvent {
  id                   String                @id @default(cuid())
  runId                String
  tour                 String
  eventName            String
  startDate            DateTime
  endDate              DateTime
  location             String
  courseName           String
  courseLat            Float?
  courseLng            Float?
  sourceUrls           Json
  createdAt            DateTime              @default(now())
  dgEventId            String?               @map("dg_event_id")
  betRecommendations   BetRecommendation[]
  fieldEntries         FieldEntry[]
  leaderboardSnapshots LeaderboardSnapshot[]
  oddsEvents           OddsEvent[]
  predictions          Prediction[]
  teeTimes             TeeTime[]
  run                  Run                   @relation(fields: [runId], references: [id], onDelete: Cascade)
  weatherForecasts     WeatherForecast[]

  @@unique([runId, tour])
  @@index([dgEventId])
  @@map("tour_events")
}

model Player {
  id            String       @id @default(cuid())
  canonicalName String       @unique
  aliases       Json
  country       String?
  tourIds       Json
  createdAt     DateTime     @default(now())
  dgId          String?      @unique
  fieldEntries  FieldEntry[]
  predictions   Prediction[]
  teeTimes      TeeTime[]

  @@map("players")
}

model FieldEntry {
  id          String    @id @default(cuid())
  runId       String
  tourEventId String
  playerId    String
  status      String
  createdAt   DateTime  @default(now())
  player      Player    @relation(fields: [playerId], references: [id])
  run         Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent   TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)

  @@unique([tourEventId, playerId])
  @@map("field_entries")
}

model TeeTime {
  id          String    @id @default(cuid())
  tourEventId String
  round       Int
  playerId    String?
  teeTimeUtc  DateTime
  tee         String
  groupMeta   Json
  createdAt   DateTime  @default(now())
  player      Player?   @relation(fields: [playerId], references: [id])
  tourEvent   TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)

  @@map("tee_times")
}

model Course {
  id        String   @id @default(cuid())
  name      String   @unique
  lat       Float?
  lng       Float?
  par       Int?
  yardage   Int?
  typeTags  Json
  notes     String?
  sources   Json
  createdAt DateTime @default(now())

  @@map("courses")
}

model WeatherForecast {
  id           String    @id @default(cuid())
  runId        String
  tourEventId  String
  forecastJson Json
  provider     String
  fetchedAt    DateTime  @default(now())
  run          Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent    TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)

  @@map("weather_forecasts")
}

model LeaderboardSnapshot {
  id              String    @id @default(cuid())
  runId           String
  tourEventId     String
  round           Int
  leaderboardJson Json
  fetchedAt       DateTime  @default(now())
  run             Run       @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent       TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)

  @@map("leaderboard_snapshots")
}

model OddsEvent {
  id              String       @id @default(cuid())
  runId           String
  tourEventId     String
  oddsProvider    String
  externalEventId String
  raw             Json
  fetchedAt       DateTime     @default(now())
  matchConfidence Float?       @map("match_confidence")
  matchMethod     String?      @map("match_method")
  run             Run          @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent       TourEvent    @relation(fields: [tourEventId], references: [id], onDelete: Cascade)
  oddsMarkets     OddsMarket[]

  @@map("odds_events")
}

model OddsMarket {
  id          String      @id @default(cuid())
  oddsEventId String
  marketKey   String
  raw         Json
  fetchedAt   DateTime    @default(now())
  oddsEvent   OddsEvent   @relation(fields: [oddsEventId], references: [id], onDelete: Cascade)
  oddsOffers  OddsOffer[]

  @@map("odds_markets")
}

model OddsOffer {
  id            String     @id @default(cuid())
  oddsMarketId  String
  selectionName String
  bookmaker     String
  oddsDecimal   Float
  oddsDisplay   String
  deepLink      String?
  fetchedAt     DateTime   @default(now())
  selectionId   String?
  matchupLabel  String?
  oddsMarket    OddsMarket @relation(fields: [oddsMarketId], references: [id], onDelete: Cascade)

  @@unique([oddsMarketId, selectionName, bookmaker])
  @@map("odds_offers")
}

model Prediction {
  id           String    @id @default(cuid())
  tourEventId  String
  playerId     String
  probsJson    Json
  modelVersion String
  createdAt    DateTime  @default(now())
  player       Player    @relation(fields: [playerId], references: [id])
  tourEvent    TourEvent @relation(fields: [tourEventId], references: [id], onDelete: Cascade)

  @@map("predictions")
}

model BetRecommendation {
  id                   String                @id @default(cuid())
  runId                String
  tier                 String
  tourEventId          String
  marketKey            String
  selection            String
  confidence1To5       Int
  bestBookmaker        String
  bestOdds             Float
  altOffersJson        Json
  analysisParagraph    String
  analysisBullets      Json
  createdAt            DateTime              @default(now())
  fairProb             Float?
  marketProb           Float?
  edge                 Float?
  ev                   Float?
  isFallback           Boolean               @default(false)
  fallbackReason       String?
  probSource           String?
  marketProbSource     String?
  fallbackType         String?
  tierStatus           String?
  mode                 String?
  booksUsed            Json?
  dgPlayerId           String?               @map("dg_player_id")
  modelConfidenceJson  Json?
  override             BetOverride?
  run                  Run                   @relation(fields: [runId], references: [id], onDelete: Cascade)
  tourEvent            TourEvent             @relation(fields: [tourEventId], references: [id], onDelete: Cascade)
  liveTrackingBaseline LiveTrackingBaseline?

  @@map("bet_recommendations")
}

model LiveTrackingBaseline {
  id                  String            @id @default(cuid())
  baselineBook        String?
  baselineOddsDecimal Float
  betRecommendationId String            @unique
  capturedAt          DateTime
  createdAt           DateTime          @default(now())
  betRecommendation   BetRecommendation @relation(fields: [betRecommendationId], references: [id], onDelete: Cascade)

  @@map("live_tracking_baselines")
}

model BetOverride {
  id                    String            @id @default(cuid())
  betRecommendationId   String            @unique
  selectionName         String?
  betTitle              String?
  confidenceRating      Int?
  aiAnalysisParagraph   String?
  affiliateLinkOverride String?
  status                String?
  courseFitScore        Int?
  formLabel             String?
  weatherLabel          String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  tierOverride          String?
  pinned                Boolean           @default(false)
  pinOrder              Int?
  betRecommendation     BetRecommendation @relation(fields: [betRecommendationId], references: [id], onDelete: Cascade)

  @@map("bet_overrides")
}

model DataIssue {
  id           String   @id @default(cuid())
  runId        String
  tour         String?
  severity     String
  step         String
  message      String
  evidenceJson Json?
  createdAt    DateTime @default(now())
  resolved     Boolean  @default(false)
  run          Run      @relation(fields: [runId], references: [id], onDelete: Cascade)

  @@map("data_issues")
}

model User {
  id                   String    @id @default(cuid())
  email                String    @unique
  password             String
  fullName             String?
  role                 String    @default("user")
  favoriteTours        Json?
  riskAppetite         String?
  notificationsEnabled Boolean   @default(true)
  emailNotifications   Boolean   @default(true)
  onboardingCompleted  Boolean   @default(false)
  totalBetsPlaced      Int       @default(0)
  totalWins            Int       @default(0)
  hioTotalPoints       Int       @default(0)
  createdAt            DateTime  @default(now())
  disabledAt           DateTime?
  disabledReason       String?

  @@map("users")
}

model SiteContent {
  key       String   @id
  json      Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("site_contents")
}

model Page {
  id          String         @id @default(cuid())
  slug        String         @unique
  title       String
  status      String         @default("draft")
  templateKey String?        @map("template_key")
  blocks      Json
  seo         Json?
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  publishedAt DateTime?      @map("published_at")
  revisions   PageRevision[]

  @@map("pages")
}

model PageRevision {
  id        String   @id @default(cuid())
  pageId    String   @map("page_id")
  version   Int
  title     String
  blocks    Json
  createdAt DateTime @default(now()) @map("created_at")
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, version])
  @@index([pageId])
  @@map("page_revisions")
}

model MediaAsset {
  id           String   @id @default(cuid())
  provider     String
  url          String
  publicId     String?  @map("public_id")
  resourceType String?  @map("resource_type")
  folder       String?
  fileName     String?  @map("file_name")
  bytes        Int?
  width        Int?
  height       Int?
  format       String?
  altText      String?  @map("alt_text")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([provider])
  @@map("media_assets")
}

model AuditLog {
  id              String   @id @default(cuid())
  action          String
  entityType      String?
  entityId        String?
  actorSub        String?
  actorEmail      String?
  actorRole       String?
  impersonatedSub String?
  beforeJson      Json?
  afterJson       Json?
  ip              String?
  userAgent       String?
  createdAt       DateTime @default(now())

  @@index([createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

model BettingProvider {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  logoUrl          String?
  affiliateBaseUrl String?
  priority         Int      @default(10)
  enabled          Boolean  @default(true)
  createdAt        DateTime @default(now())

  @@map("betting_providers")
}

model MembershipPackage {
  id              String                   @id @default(cuid())
  name            String
  description     String?
  price           Float
  billingPeriod   String
  features        Json
  badges          Json
  stripePriceId   String?
  displayOrder    Int                      @default(0)
  enabled         Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  stripeProductId String?
  subscriptions   MembershipSubscription[]

  @@map("membership_packages")
}

model MembershipSubscription {
  id                   String            @id @default(cuid())
  userEmail            String
  packageId            String
  packageName          String
  status               String
  billingPeriod        String
  pricePaid            Float
  lifetimeValue        Float?
  nextPaymentDate      DateTime?
  createdDate          DateTime          @default(now())
  cancelledAt          DateTime?
  cancelAtPeriodEnd    Boolean?
  stripeCustomerId     String?
  stripeSubscriptionId String?           @unique
  stripePriceId        String?
  package              MembershipPackage @relation(fields: [packageId], references: [id], onDelete: Cascade)

  @@map("membership_subscriptions")
}

model HIOChallenge {
  id               String     @id @default(cuid())
  status           String     @default("active")
  prizeDescription String?
  tournamentNames  Json?
  questions        Json
  totalEntries     Int        @default(0)
  perfectScores    Int        @default(0)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  entries          HIOEntry[]

  @@index([status])
  @@map("hio_challenges")
}

model HIOEntry {
  id          String       @id @default(cuid())
  challengeId String
  userEmail   String
  answers     Json
  submittedAt DateTime     @default(now())
  score       Int?
  isPerfect   Boolean?
  challenge   HIOChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([challengeId, userEmail])
  @@index([userEmail])
  @@map("hio_entries")
}

model SelectionRun {
  id                     String                   @id @default(cuid())
  runKey                 String                   @unique
  status                 String
  weekStart              DateTime
  weekEnd                DateTime
  scheduleSuccess        Boolean                  @default(false)
  fieldSuccess           Boolean                  @default(false)
  predsSuccess           Boolean                  @default(false)
  oddsSuccess            Boolean                  @default(false)
  toursProcessed         Json?
  eventsProcessed        Int                      @default(0)
  recommendationsCreated Int                      @default(0)
  failureReason          String?
  failureStep            String?
  createdAt              DateTime                 @default(now())
  completedAt            DateTime?
  inputHash              String?
  inputSummaryJson       Json?
  modelConfidenceJson    Json?
  outcomeMetricsJson     Json?
  oddsSnapshot           OddsSnapshot?
  outcomeMetrics         SelectionOutcomeMetric[]
  selectionResults       SelectionResult[]

  @@index([status])
  @@index([createdAt])
  @@map("selection_runs")
}

model OddsSnapshot {
  id              String       @id @default(cuid())
  selectionRunId  String       @unique
  snapshotJson    Json
  toursIncluded   Json
  marketsIncluded Json
  fetchedAt       DateTime     @default(now())
  selectionRun    SelectionRun @relation(fields: [selectionRunId], references: [id], onDelete: Cascade)

  @@map("odds_snapshots")
}

model SelectionResult {
  id                  String                   @id @default(cuid())
  selectionRunId      String
  tier                String
  tour                String
  eventName           String
  marketKey           String
  selection           String
  dgPlayerId          String?                  @map("dg_player_id")
  engineFairProb      Float?
  engineMarketProb    Float?
  engineEdge          Float?
  engineEv            Float?
  engineConfidence    Int
  engineBestOdds      Float
  engineBestBook      String
  engineAltOffers     Json
  oddsSnapshotRef     String?
  analysisParagraph   String
  analysisBullets     Json
  hasOverride         Boolean                  @default(false)
  overrideAppliedAt   DateTime?
  overrideBy          String?
  createdAt           DateTime                 @default(now())
  modelConfidenceJson Json?
  outcomeMetrics      SelectionOutcomeMetric[]
  selectionRun        SelectionRun             @relation(fields: [selectionRunId], references: [id], onDelete: Cascade)

  @@index([selectionRunId])
  @@index([tour, tier])
  @@map("selection_results")
}

model SelectionOutcomeMetric {
  id                String           @id @default(cuid())
  selectionRunId    String
  selectionResultId String?
  tour              String
  eventName         String
  marketKey         String
  selection         String
  predictedProb     Float?
  actualOutcome     Float?
  confidenceOverall Float?
  confidenceJson    Json?
  dgProb            Float?
  divergence        Float?
  settledAt         DateTime?
  createdAt         DateTime         @default(now())
  selectionResult   SelectionResult? @relation(fields: [selectionResultId], references: [id])
  selectionRun      SelectionRun     @relation(fields: [selectionRunId], references: [id], onDelete: Cascade)

  @@index([selectionRunId])
  @@index([selectionResultId])
  @@index([tour, marketKey])
  @@map("selection_outcome_metrics")
}
